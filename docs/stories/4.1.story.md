# Story 4.1: Weekly Report Generation

**Epic:** 4 — Intelligence & Reports
**Status:** Draft
**Priority:** High
**Story Type:** API + Integration + Frontend

---

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["architecture-review", "code-standards"]

---

## Story Statement

> As a mentee,
> I want to receive an automated weekly report analyzing my emotional patterns,
> so that I can understand my progress and have a challenge for the next week.

---

## Acceptance Criteria

- [ ] **AC1:** Cron job ou scheduled function que gera relatórios semanais (domingo à noite ou configurável)
- [ ] **AC2:** API Route (`POST /api/reports/weekly`) que agrega registros da semana e chama Claude API
- [ ] **AC3:** Relatório contém: resumo da semana, padrões identificados, evolução comparativa (vs. semana anterior), insight da semana (conectado ao A.D.V.), desafio prático para próxima semana
- [ ] **AC4:** Relatório salvo na tabela `weekly_reports`
- [ ] **AC5:** Rota `/reports/weekly/{id}` para mentorado visualizar relatório com layout dedicado e seções bem definidas
- [ ] **AC6:** Lista de relatórios acessível em `/reports` com links para cada semana
- [ ] **AC7:** Se mentorado tem menos de 3 registros na semana, gerar relatório simplificado com nota sobre consistência
- [ ] **AC8:** Relatório funciona tanto para mentorados quanto para o mentor (quando usando Meu Diário)

---

## Dev Notes

### Claude API — Weekly Report System Prompt
[Source: diario-autogoverno-briefing.md]
- Tom: Analítico, usa dados reais, identifica padrões
- Conteúdo: resumo, padrões, evolução, insight (A.D.V.), desafio prático
- Se < 3 registros: relatório simplificado + nota sobre consistência
- Framework A.D.V.: Autogoverno, Direção, Verdade

### Weekly Report Data Model
[Source: docs/architecture.md#data-models]
```typescript
interface WeeklyReport {
  id: string;
  user_id: string;
  week_start: string;     // YYYY-MM-DD (Monday)
  week_end: string;       // YYYY-MM-DD (Sunday)
  summary: string;
  patterns: { description: string; frequency: number; category?: Category; emotion?: Emotion; }[];
  evolution: { avg_intensity_current: number; avg_intensity_previous: number; reactive_pct: number; strategic_pct: number; };
  insight: string;
  challenge: string;
  created_at: string;
}
```

### API Endpoints
[Source: docs/architecture.md#api-specification]
- `POST /api/reports/weekly` — generate report (called by cron or manually). Auth: System/Cron or authenticated user
- `GET /api/reports` — list user's reports. Auth: Mentee/Mentor
- `GET /api/reports/[id]` — report details. Auth: Owner

### Cron Strategy
[Source: docs/architecture.md#high-level-architecture]
- Vercel Cron Jobs (free tier: 1/day)
- Schedule: Sunday 23:00 BRT (or `vercel.json` cron config)
- Endpoint: `POST /api/reports/weekly` with CRON_SECRET header

### Component Specs
[Source: docs/architecture.md#components]
- Weekly Report Viewer: `ReportView`, `PatternSection`, `EvolutionSection`, `InsightSection`, `ChallengeSection`
- Technology: Server Components

### File Locations
- Report list page: `packages/web/src/app/(mentee)/reports/page.tsx`
- Report detail page: `packages/web/src/app/(mentee)/reports/[id]/page.tsx`
- API Routes: `packages/web/src/app/api/reports/weekly/route.ts`, `packages/web/src/app/api/reports/route.ts`, `packages/web/src/app/api/reports/[id]/route.ts`
- AI Prompts: `packages/web/src/lib/ai/prompts.ts` (add weekly report prompt)
- Service: `packages/web/src/lib/services/report-service.ts`
- DB: `packages/web/src/lib/db/reports.ts`
- Cron config: `vercel.json`

---

## Tasks / Subtasks

- [ ] **Task 1** (AC: 2): Create `report-service.ts` — aggregate entries for a week, compute evolution vs previous week, call Claude API for analysis
- [ ] **Task 2** (AC: 3): Create weekly report system prompt in `prompts.ts` — analytic tone, A.D.V. framework, includes: summary, patterns, evolution, insight, challenge
- [ ] **Task 3** (AC: 2): Create API Route `POST /api/reports/weekly` — generates report for a user/week, with CRON_SECRET validation for automated calls
- [ ] **Task 4** (AC: 7): Implement simplified report logic — if < 3 entries, generate brief summary with consistency note instead of full analysis
- [ ] **Task 5** (AC: 4): Save generated report to `weekly_reports` table with all structured fields
- [ ] **Task 6** (AC: 6): Create API Route `GET /api/reports` — list user's weekly reports (most recent first)
- [ ] **Task 7** (AC: 6): Create reports list page at `/reports` — chronological list with week range and summary preview
- [ ] **Task 8** (AC: 5): Create report detail page at `/reports/[id]` — sections: Resumo, Padrões, Evolução, Insight, Desafio
- [ ] **Task 9** (AC: 1): Configure Vercel Cron Job in `vercel.json` — schedule Sunday 23:00 BRT, endpoint `POST /api/reports/weekly`
- [ ] **Task 10** (AC: 8): Ensure report generation works for both mentee and mentor roles
- [ ] **Task 11**: Write unit tests for report-service aggregation, simplified report logic, and AI prompt

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## File List

_To be updated during implementation._

---

## Dev Agent Record

_To be filled by @dev during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story drafted | @sm |

---

## QA Results

_To be filled by @qa during review._
