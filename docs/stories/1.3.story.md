# Story 1.3: Authentication Flow

**Epic:** 1 — Foundation & Authentication
**Status:** Draft
**Priority:** Critical Path
**Story Type:** Frontend + Security

---

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["architecture-review", "code-standards"]

---

## Story Statement

> As a mentee,
> I want to create an account and login securely,
> so that I can access my personal diary.

---

## Acceptance Criteria

- [ ] **AC1:** Página de login (`/login`) com campos email e senha, dark mode, e branding (logo/nome do app)
- [ ] **AC2:** Página de cadastro (`/register`) com campos nome, email, senha — acessível apenas via link de convite (query param `?invite=TOKEN`)
- [ ] **AC3:** Integração com Supabase Auth para criação de conta e login
- [ ] **AC4:** Redirect para `/` (home) após login bem-sucedido
- [ ] **AC5:** Redirect para `/login` quando usuário não autenticado tenta acessar rotas protegidas
- [ ] **AC6:** Middleware Next.js para proteção de rotas autenticadas
- [ ] **AC7:** Logout funcional com limpeza de sessão
- [ ] **AC8:** Mensagens de erro claras para: email já cadastrado, credenciais inválidas, link de convite inválido
- [ ] **AC9:** Estado de loading durante operações de auth

---

## Dev Notes

### Wireframe — Login
[Source: docs/architecture/wireframes-mvp-phase1.md#1-login]
- Route: `/login`
- Layout: mobile-first, centered 400px container
- Components: Heading (app name), Input (email), Input (password), Button (primary red #E53935 "Entrar"), Text link ("Primeiro acesso? Usar convite")
- On desktop: container stays 400px centered
- Interactions: click "Entrar" → auth → redirect to `/` (mentee) or `/dashboard` (mentor) based on role

### Wireframe — Register
[Source: docs/architecture/wireframes-mvp-phase1.md#2-register]
- Route: `/register`
- Fields: Código de convite, Nome completo, Email, Senha
- Button: "Criar conta" (#E53935)
- Role auto-set to `mentee` on registration
- Invite code validated server-side
- Link back to `/login`

### Middleware Pattern
[Source: docs/architecture.md#routing-architecture]
```typescript
// middleware.ts
export async function middleware(request: NextRequest) {
  const { supabase, response } = createMiddlewareClient(request);
  const { data: { session } } = await supabase.auth.getSession();
  // Not authenticated → redirect /login
  // Authenticated on auth page → redirect /
  // /dashboard routes → verify role is 'mentor'
}
export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|api).*)'],
};
```

### Auth Flow
[Source: docs/architecture.md#core-workflows]
- Login: `signInWithPassword()` → session cookie → redirect
- Register: validate invite → `signUp()` → insert `users` row → redirect
- Logout: `signOut()` → redirect `/login`

### File Locations
[Source: docs/architecture.md#frontend-architecture]
- Login page: `packages/web/src/app/(auth)/login/page.tsx`
- Register page: `packages/web/src/app/(auth)/register/page.tsx`
- Middleware: `packages/web/src/middleware.ts`
- Auth components: `packages/web/src/components/auth/`
- Auth hook: `packages/web/src/hooks/use-auth.ts`
- Supabase middleware helper: `packages/web/src/lib/supabase/middleware.ts`

### Component Specs
[Source: docs/architecture.md#components]
- Auth Module: `LoginForm`, `RegisterForm`, `AuthProvider`, `useAuth` hook
- Dependencies: Supabase Auth SDK, Next.js Middleware
- Technology: Server Components for layout, Client Components for forms

---

## Tasks / Subtasks

- [ ] **Task 1** (AC: 6): Create Next.js middleware for route protection — redirect unauthenticated to `/login`, redirect authenticated from auth pages to `/`, verify mentor role for `/dashboard` routes
- [ ] **Task 2** (AC: 1): Create login page at `(auth)/login/page.tsx` with email/password fields, dark mode, branding, "Entrar" button (#E53935), link to register
- [ ] **Task 3** (AC: 2): Create register page at `(auth)/register/page.tsx` with invite code, name, email, password fields, "Criar conta" button
- [ ] **Task 4** (AC: 2): Implement server-side invite code validation (create `invites` table or simple config-based validation)
- [ ] **Task 5** (AC: 3): Implement Supabase Auth integration — `signInWithPassword()` for login, `signUp()` + user insert for register
- [ ] **Task 6** (AC: 4): Implement post-login redirect logic — mentee → `/`, mentor → `/dashboard`
- [ ] **Task 7** (AC: 7): Implement logout functionality with session cleanup
- [ ] **Task 8** (AC: 8): Add error handling and error messages for auth failures
- [ ] **Task 9** (AC: 9): Add loading states during auth operations (button spinner, disabled state)
- [ ] **Task 10**: Create `useAuth` hook for auth state management
- [ ] **Task 11**: Create `AuthProvider` context for session management
- [ ] **Task 12**: Write unit tests for auth components and middleware logic

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## File List

_To be updated during implementation._

---

## Dev Agent Record

_To be filled by @dev during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story drafted | @sm |

---

## QA Results

_To be filled by @qa during review._
