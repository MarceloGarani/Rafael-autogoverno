# Story 2.2: AI Reflection Generation

**Epic:** 2 â€” Daily Entry & AI Reflection
**Status:** Draft
**Priority:** Critical Path
**Story Type:** API + Frontend + Integration

---

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["architecture-review", "code-standards"]

---

## Story Statement

> As a mentee,
> I want to receive personalized reflective questions from AI after my entry,
> so that I can deepen my self-awareness through the A.D.V. framework.

---

## Acceptance Criteria

- [ ] **AC1:** ApÃ³s salvar a entry, redirecionar para `/entry/{id}/reflection`
- [ ] **AC2:** AnimaÃ§Ã£o de "processando" exibida enquanto IA gera reflexÃµes (1-3 segundos)
- [ ] **AC3:** API Route (`POST /api/reflections`) que chama Claude API server-side com system prompt do CÃ³digo A.D.V. e dados do registro
- [ ] **AC4:** System prompt implementado conforme briefing: tom direto, firme, provocativo; NÃƒO coach motivacional; NÃƒO terapeuta; framework A.D.V. (Autogoverno, DireÃ§Ã£o, Verdade)
- [ ] **AC5:** IA gera exatamente 2-3 perguntas reflexivas personalizadas baseadas no registro
- [ ] **AC6:** Perguntas exibidas uma por vez com campo de texto opcional abaixo de cada uma
- [ ] **AC7:** Mentorado pode responder todas, algumas ou nenhuma
- [ ] **AC8:** BotÃ£o "Finalizar" salva respostas (ou null se nÃ£o respondidas) no Supabase (tabela ai_reflections)
- [ ] **AC9:** Tela de confirmaÃ§Ã£o: "Registro salvo. Mais um dia de autogoverno." + streak atualizado
- [ ] **AC10:** Se a API Claude falhar, exibir mensagem graceful e salvar o registro sem reflexÃ£o (nÃ£o bloquear o fluxo)

---

## Dev Notes

### Wireframe â€” AI Reflection
[Source: docs/architecture/wireframes-mvp-phase1.md#7-ai-reflection]
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  Sua ReflexÃ£o               â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  âœ¦ Processando...      â”‚    â”‚
â”‚  â”‚  (skeleton animation)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â†“ (after AI responds)   â”‚
â”‚                                â”‚
â”‚  Pergunta 1/3                  â”‚
â”‚  "Quando vocÃª percebeu que..." â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Sua resposta (opcional)â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚     PRÃ“XIMA â†’          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚     PULAR              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Wireframe â€” Confirmation
[Source: docs/architecture/wireframes-mvp-phase1.md#8-confirmation]
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚           âœ“                    â”‚
â”‚                                â”‚
â”‚  Registro salvo.               â”‚
â”‚  Mais um dia de autogoverno.   â”‚
â”‚                                â”‚
â”‚  ðŸ”¥ 13 dias consecutivos       â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   VOLTAR AO INÃCIO     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Claude API Integration
[Source: docs/architecture.md#external-apis]
- Model: `claude-sonnet-4-20250514`
- Server-side only (never expose API key to client)
- Retry with exponential backoff for 429/529 errors
- Timeout: 30s per request
- Graceful fallback: if API fails, save entry without reflection

### System Prompt â€” ReflexÃµes PÃ³s-Registro
[Source: diario-autogoverno-briefing.md]
Tom: Direto, firme, provocativo. Como um mentor que respeita o mentorado o suficiente para ser honesto.
- NÃƒO ser coach motivacional genÃ©rico
- NÃƒO ser terapeuta
- Usar framework A.D.V. (Autogoverno, DireÃ§Ã£o, Verdade)
- Gerar exatamente 2-3 perguntas reflexivas
- Perguntas devem ser personalizadas com base nos dados do registro (situaÃ§Ã£o, emoÃ§Ã£o, intensidade, reaÃ§Ã£o, autopercepÃ§Ã£o)

### API Endpoints
[Source: docs/architecture.md#api-specification]
- `POST /api/reflections` â€” body: `{ entry_id }` â†’ calls Claude API â†’ returns `{ questions: string[] }`
- `PUT /api/reflections/[id]` â€” body: `{ answers: (string|null)[] }` â†’ saves responses

### Component Specs
[Source: docs/architecture.md#components]
- AI Reflection Viewer: `ReflectionView`, `QuestionCard`, `AnswerInput`
- Client Component with loading animation for progressive display

### File Locations
- Page: `packages/web/src/app/(mentee)/reflection/[id]/page.tsx`
- Confirmation: can be rendered within the same page or separate route
- Components: `packages/web/src/components/reflection/` â€” ReflectionView.tsx, QuestionCard.tsx, AnswerInput.tsx
- API Routes: `packages/web/src/app/api/reflections/route.ts`, `packages/web/src/app/api/reflections/[id]/route.ts`
- AI Client: `packages/web/src/lib/ai/client.ts`
- AI Prompts: `packages/web/src/lib/ai/prompts.ts`
- AI Generate: `packages/web/src/lib/ai/generate.ts`
- Service: `packages/web/src/lib/services/reflection-service.ts`
- DB: `packages/web/src/lib/db/reflections.ts`

---

## Tasks / Subtasks

- [ ] **Task 1** (AC: 3): Setup Anthropic SDK â€” create `lib/ai/client.ts` with singleton Anthropic client initialization using `ANTHROPIC_API_KEY`
- [ ] **Task 2** (AC: 4): Create system prompts in `lib/ai/prompts.ts` â€” reflection prompt following A.D.V. framework (direct, provocative, NOT motivational coach or therapist)
- [ ] **Task 3** (AC: 3, 5): Create `lib/ai/generate.ts` â€” `generateReflection(entry: DailyEntry)` function that calls Claude API and returns 2-3 questions
- [ ] **Task 4** (AC: 3): Create API Route `POST /api/reflections` â€” receive entry_id, fetch entry data, call AI, insert into ai_reflections, return questions
- [ ] **Task 5**: Create API Route `PUT /api/reflections/[id]` â€” receive answers array, update ai_reflections
- [ ] **Task 6** (AC: 2): Create loading animation component â€” "Processando..." with skeleton or pulsing animation
- [ ] **Task 7** (AC: 6, 7): Create `ReflectionView` â€” displays questions one at a time with optional answer field, "PrÃ³xima"/"Pular" buttons, progress indicator (1/3)
- [ ] **Task 8** (AC: 8): Create "Finalizar" button â€” saves all answers (null for skipped), redirects to confirmation
- [ ] **Task 9** (AC: 9): Create confirmation view â€” success message, updated streak counter, "Voltar ao inÃ­cio" button
- [ ] **Task 10** (AC: 10): Implement error handling â€” if Claude API fails, show message "NÃ£o foi possÃ­vel gerar reflexÃµes agora", allow user to proceed to confirmation
- [ ] **Task 11** (AC: 10): Implement retry logic with exponential backoff for 429/529 errors
- [ ] **Task 12**: Create DB layer `lib/db/reflections.ts` and service `lib/services/reflection-service.ts`
- [ ] **Task 13**: Write unit tests for AI prompt construction, reflection-service, and ReflectionView component

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## File List

_To be updated during implementation._

---

## Dev Agent Record

_To be filled by @dev during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story drafted | @sm |

---

## QA Results

_To be filled by @qa during review._
