# Story 5.1: Streak & Badge System

**Epic:** 5 — Engagement & PWA
**Status:** Draft
**Priority:** Medium
**Story Type:** API + Frontend + Database

---

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["architecture-review", "code-standards"]

---

## Story Statement

> As a mentee,
> I want to earn streaks and badges for consistency,
> so that I'm motivated to maintain my daily practice.

---

## Acceptance Criteria

- [ ] **AC1:** Lógica de streak: incrementa ao registrar em dias consecutivos, reseta quando pula um dia, calcula streak atual e maior streak
- [ ] **AC2:** Streak exibido na home e na tela de confirmação pós-registro
- [ ] **AC3:** Badges de consistência: "7 dias" (primeira semana completa), "30 dias" (primeiro mês), "Semana perfeita" (7/7 dias), "Mestre do Autogoverno" (90 dias)
- [ ] **AC4:** Tabela `badges` no banco: id, user_id, badge_type, earned_at
- [ ] **AC5:** Notificação in-app ao conquistar um badge
- [ ] **AC6:** Badges visíveis na tela de Progresso/Evolução
- [ ] **AC7:** Lógica de badges roda automaticamente após cada registro (via trigger ou lógica na API)

---

## Dev Notes

### Badge Types
[Source: docs/architecture.md#data-models]
```typescript
type BadgeType = '7_days' | '30_days' | '90_days' | 'perfect_week';
```

| Badge | Condition | Display Name |
|-------|-----------|-------------|
| `7_days` | Current streak reaches 7 | "7 Dias" |
| `30_days` | Current streak reaches 30 | "30 Dias" |
| `90_days` | Current streak reaches 90 | "Mestre do Autogoverno" |
| `perfect_week` | 7/7 entries in a calendar week | "Semana Perfeita" |

### Streak Calculation
[Source: docs/architecture.md#helper-functions]
- PostgreSQL function `get_user_streak(p_user_id)` already defined in Story 1.2
- Returns: `{ current_streak, max_streak }`
- Validates streak is current (last entry within last 1 day)

### Badge Table (already created in Story 1.2)
```sql
CREATE TABLE public.badges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    badge_type badge_type NOT NULL,
    earned_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(user_id, badge_type)
);
```

### Badge Check Logic (post-entry)
```typescript
async function checkAndAwardBadges(userId: string, currentStreak: number) {
  // Check streak-based badges
  if (currentStreak >= 7) await awardBadge(userId, '7_days');
  if (currentStreak >= 30) await awardBadge(userId, '30_days');
  if (currentStreak >= 90) await awardBadge(userId, '90_days');

  // Check perfect week
  const weekEntries = await getEntriesThisWeek(userId);
  if (weekEntries.length >= 7) await awardBadge(userId, 'perfect_week');
}
// UNIQUE constraint prevents duplicate badges
```

### API Endpoints
[Source: docs/architecture.md#api-specification]
- `GET /api/progress/streak` — returns `{ current_streak, max_streak }`
- Badges included in `GET /api/progress` response

### File Locations
- Badge logic: `packages/web/src/lib/services/entry-service.ts` (post-entry hook)
- Badge display: `packages/web/src/components/progress/BadgeGrid.tsx`
- Notification: in-app toast component
- DB: `packages/web/src/lib/db/badges.ts`

---

## Tasks / Subtasks

- [ ] **Task 1** (AC: 1): Implement streak calculation in entry-service — after each entry creation, calculate current and max streak using `get_user_streak()` RPC
- [ ] **Task 2** (AC: 7): Create badge check function — runs after each entry save, checks streak thresholds and perfect week condition
- [ ] **Task 3** (AC: 3): Implement badge awarding with UPSERT pattern — insert badge if not already earned (UNIQUE constraint handles duplicates)
- [ ] **Task 4** (AC: 5): Create in-app toast notification for new badge — "Parabéns! Você conquistou o badge {badge_name}!"
- [ ] **Task 5** (AC: 2): Ensure streak is displayed on home page (StreakCounter component) and confirmation screen (updated after new entry)
- [ ] **Task 6** (AC: 6): Create `BadgeGrid` component — grid of badge icons with earned/unearned states, displayed on `/progress` page
- [ ] **Task 7** (AC: 4): Create DB layer `lib/db/badges.ts` — insert, list badges for user
- [ ] **Task 8**: Write unit tests for badge check logic, streak thresholds, and perfect week detection

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## File List

_To be updated during implementation._

---

## Dev Agent Record

_To be filled by @dev during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story drafted | @sm |

---

## QA Results

_To be filled by @qa during review._
