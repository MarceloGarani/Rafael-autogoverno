# Story 1.2: Supabase Database Schema & RLS

**Epic:** 1 — Foundation & Authentication
**Status:** Draft
**Priority:** Critical Path
**Story Type:** Database

---

## Executor Assignment

executor: "@data-engineer"
quality_gate: "@dev"
quality_gate_tools: ["schema-validation", "rls-test", "migration-check"]

---

## Story Statement

> As a data engineer,
> I want to create the database schema with proper RLS policies,
> so that user data is properly isolated and secure.

---

## Acceptance Criteria

- [ ] **AC1:** Tabelas criadas no Supabase: `users`, `daily_entries`, `ai_reflections`
- [ ] **AC2:** Enums criados para: category (audiencia, negociacao, cliente, cobranca, equipe, decisao, outro), emotion (ansiedade, raiva, medo, frustracao, inseguranca, culpa, outro), self_perception (reactive, strategic, unsure)
- [ ] **AC3:** Foreign keys configuradas corretamente (daily_entries.user_id → users.id, ai_reflections.entry_id → daily_entries.id)
- [ ] **AC4:** RLS habilitado em todas as tabelas
- [ ] **AC5:** Políticas RLS: mentorados só leem/escrevem seus próprios dados; mentor lê dados de todos os mentorados mas NÃO seus próprios no contexto de dashboard
- [ ] **AC6:** Migration files criados em `supabase/migrations/`
- [ ] **AC7:** Seed data com pelo menos 1 usuário mentor e 2 mentorados de teste

---

## Dev Notes

### Complete DDL
[Source: docs/architecture.md#database-schema]

```sql
-- Enums
CREATE TYPE user_role AS ENUM ('mentee', 'mentor');
CREATE TYPE entry_category AS ENUM ('audiencia', 'negociacao', 'cliente', 'cobranca', 'equipe', 'decisao', 'outro');
CREATE TYPE entry_emotion AS ENUM ('ansiedade', 'raiva', 'medo', 'frustracao', 'inseguranca', 'culpa', 'outro');
CREATE TYPE self_perception_type AS ENUM ('reactive', 'strategic', 'unsure');
CREATE TYPE badge_type AS ENUM ('7_days', '30_days', '90_days', 'perfect_week');

-- Users (extends Supabase auth.users)
CREATE TABLE public.users (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    role user_role NOT NULL DEFAULT 'mentee',
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Daily Entries
CREATE TABLE public.daily_entries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    situation TEXT NOT NULL,
    category entry_category NOT NULL,
    emotion entry_emotion NOT NULL,
    intensity INTEGER NOT NULL CHECK (intensity >= 1 AND intensity <= 10),
    reaction TEXT NOT NULL,
    self_perception self_perception_type NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(user_id, date)
);

-- AI Reflections
CREATE TABLE public.ai_reflections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entry_id UUID NOT NULL UNIQUE REFERENCES public.daily_entries(id) ON DELETE CASCADE,
    questions JSONB NOT NULL,
    answers JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Weekly Reports
CREATE TABLE public.weekly_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    week_start DATE NOT NULL,
    week_end DATE NOT NULL,
    summary TEXT NOT NULL,
    patterns JSONB NOT NULL,
    evolution JSONB NOT NULL,
    insight TEXT NOT NULL,
    challenge TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(user_id, week_start)
);

-- Mentor Notes
CREATE TABLE public.mentor_notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mentor_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    mentee_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    content TEXT NOT NULL DEFAULT '',
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(mentor_id, mentee_id)
);

-- Session Briefings
CREATE TABLE public.session_briefings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mentor_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    mentee_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    generated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    summary TEXT NOT NULL,
    patterns JSONB NOT NULL,
    suggested_topics JSONB NOT NULL,
    suggested_questions JSONB NOT NULL,
    mentor_previous_notes TEXT
);

-- Badges
CREATE TABLE public.badges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    badge_type badge_type NOT NULL,
    earned_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(user_id, badge_type)
);

-- Indexes
CREATE INDEX idx_daily_entries_user_date ON public.daily_entries(user_id, date DESC);
CREATE INDEX idx_daily_entries_user_category ON public.daily_entries(user_id, category);
CREATE INDEX idx_daily_entries_user_emotion ON public.daily_entries(user_id, emotion);
CREATE INDEX idx_weekly_reports_user ON public.weekly_reports(user_id, week_start DESC);
CREATE INDEX idx_session_briefings_mentee ON public.session_briefings(mentee_id, generated_at DESC);
CREATE INDEX idx_badges_user ON public.badges(user_id);
```

### RLS Policies
[Source: docs/architecture.md#row-level-security]

```sql
-- Enable RLS on all tables
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.daily_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ai_reflections ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.weekly_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.mentor_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.session_briefings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.badges ENABLE ROW LEVEL SECURITY;

-- Users: can read own profile, mentor can read all mentees
CREATE POLICY "users_read_own" ON public.users FOR SELECT USING (auth.uid() = id);
CREATE POLICY "mentor_read_mentees" ON public.users FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'mentor') AND role = 'mentee'
);

-- Daily Entries: own data + mentor read
CREATE POLICY "entries_own_read" ON public.daily_entries FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "entries_own_insert" ON public.daily_entries FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "mentor_read_mentee_entries" ON public.daily_entries FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'mentor') AND user_id != auth.uid()
);

-- AI Reflections: via entry ownership
CREATE POLICY "reflections_own_read" ON public.ai_reflections FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.daily_entries WHERE id = entry_id AND user_id = auth.uid())
);
CREATE POLICY "reflections_own_insert" ON public.ai_reflections FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM public.daily_entries WHERE id = entry_id AND user_id = auth.uid())
);
CREATE POLICY "reflections_own_update" ON public.ai_reflections FOR UPDATE USING (
    EXISTS (SELECT 1 FROM public.daily_entries WHERE id = entry_id AND user_id = auth.uid())
);
CREATE POLICY "mentor_read_mentee_reflections" ON public.ai_reflections FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.daily_entries de JOIN public.users u ON u.id = auth.uid()
    WHERE de.id = entry_id AND u.role = 'mentor' AND de.user_id != auth.uid())
);

-- Mentor Notes, Session Briefings, Badges — see full DDL above
```

### Streak Helper Function
[Source: docs/architecture.md#helper-functions]

```sql
CREATE OR REPLACE FUNCTION get_user_streak(p_user_id UUID)
RETURNS TABLE(current_streak INT, max_streak INT) AS $$
-- Full implementation in architecture.md
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### File Locations
[Source: docs/architecture.md#repository-structure]
- Migrations: `supabase/migrations/`
- Seed: `supabase/seed.sql`
- Supabase config: `supabase/config.toml`

### Data Model Types
[Source: docs/architecture.md#data-models]
- TypeScript types to be generated: `packages/web/src/types/database.ts`
- Use `supabase gen types typescript` for auto-generation

---

## Tasks / Subtasks

- [ ] **Task 1** (AC: 6): Initialize Supabase project (`supabase init`) and create migration directory
- [ ] **Task 2** (AC: 2): Create migration for enums (user_role, entry_category, entry_emotion, self_perception_type, badge_type)
- [ ] **Task 3** (AC: 1, 3): Create migration for tables (users, daily_entries, ai_reflections, weekly_reports, mentor_notes, session_briefings, badges) with all foreign keys, constraints, and indexes
- [ ] **Task 4** (AC: 4, 5): Create migration for RLS policies — enable RLS on all tables and create all policies per architecture spec
- [ ] **Task 5**: Create migration for `get_user_streak()` helper function
- [ ] **Task 6** (AC: 7): Create seed data file with 1 mentor (Rafael) and 2 test mentees with sample entries
- [ ] **Task 7**: Generate TypeScript types from schema into `packages/web/src/types/database.ts`
- [ ] **Task 8**: Create Supabase client utilities: `packages/web/src/lib/supabase/client.ts` (browser), `server.ts` (server), `middleware.ts`
- [ ] **Task 9**: Verify all migrations apply cleanly with `supabase db push`

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## File List

_To be updated during implementation._

---

## Dev Agent Record

_To be filled by @dev during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story drafted | @sm |

---

## QA Results

_To be filled by @qa during review._
