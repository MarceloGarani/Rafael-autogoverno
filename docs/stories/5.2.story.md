# Story 5.2: Email Reminders

**Epic:** 5 — Engagement & PWA
**Status:** Draft
**Priority:** Medium
**Story Type:** API + Integration

---

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["architecture-review", "code-standards"]

---

## Story Statement

> As a mentee,
> I want to receive email reminders to register my day,
> so that I don't forget my daily practice.

---

## Acceptance Criteria

- [ ] **AC1:** Email reminder enviado diariamente (20h ou horário configurável) para mentorados que ainda não registraram no dia
- [ ] **AC2:** Conteúdo do email: "Como foi seu dia na advocacia?" com link direto para o formulário de registro
- [ ] **AC3:** Integração com serviço de email (Resend ou Supabase Edge Functions com SMTP)
- [ ] **AC4:** Mentorado pode desativar lembretes nas configurações
- [ ] **AC5:** Não enviar para mentorados que já registraram no dia
- [ ] **AC6:** Template de email alinhado com branding (dark mode, cores, tom direto)

---

## Dev Notes

### Email Service
[Source: docs/architecture.md#external-apis]
- Service: Resend (recommended)
- API: `POST https://api.resend.com/emails`
- Auth: API Key via `RESEND_API_KEY` env var
- Free tier: 100 emails/day, 3000/month
- SDK: `resend` npm package

### Cron Strategy
- Vercel Cron Job: daily at 20:00 BRT (23:00 UTC)
- Endpoint: `POST /api/reminders/daily` with CRON_SECRET validation
- Query: users WHERE role = 'mentee' AND no entry today AND reminders_enabled = true

### Email Template
- Subject: "Como foi seu dia na advocacia?"
- Body: dark background, branding colors, direct CTA link to `/entry/new`
- Tone: direct, brief, motivating (aligned with A.D.V.)

### User Preferences
- Need to add `reminder_enabled` (boolean, default true) to `users` table or a separate `user_preferences` table
- Settings page for mentee to toggle reminders

### Backend Components
[Source: docs/architecture.md#components]
- Email Service: `packages/web/src/lib/services/email-service.ts`
- Dependencies: Resend SDK

### File Locations
- Cron API Route: `packages/web/src/app/api/reminders/daily/route.ts`
- Email service: `packages/web/src/lib/services/email-service.ts`
- Email template: inline HTML template in email service (or React Email)
- Cron config: `vercel.json` (add daily reminder cron)
- Settings page: `packages/web/src/app/(mentee)/settings/page.tsx` (or profile page)

---

## Tasks / Subtasks

- [ ] **Task 1** (AC: 3): Install Resend SDK and create `email-service.ts` — configure with API key, create `sendReminderEmail()` function
- [ ] **Task 2** (AC: 6): Create email template — HTML with dark background (#000), red CTA button (#E53935), white text, direct tone
- [ ] **Task 3** (AC: 1, 5): Create API Route `POST /api/reminders/daily` — query mentees without today's entry and with reminders enabled, send emails via Resend
- [ ] **Task 4** (AC: 1): Configure Vercel Cron in `vercel.json` — daily at 20:00 BRT, endpoint `POST /api/reminders/daily`
- [ ] **Task 5** (AC: 4): Add reminder preference — migration to add `reminder_enabled` column (default true) to users table, or create user_preferences table
- [ ] **Task 6** (AC: 4): Create settings UI — toggle switch for email reminders
- [ ] **Task 7** (AC: 5): Implement check — skip users who already have entry for `CURRENT_DATE`
- [ ] **Task 8**: Write unit tests for reminder logic, email template generation

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## File List

_To be updated during implementation._

---

## Dev Agent Record

_To be filled by @dev during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 1.0 | Story drafted | @sm |

---

## QA Results

_To be filled by @qa during review._
